<!DOCTYPE html><html class="theme-next mist" lang="zh-Hans"><head><meta name="generator" content="Hexo 3.9.0"><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"><meta name="theme-color" content="#222"><link rel="manifest" href="/manifest.json"><link rel="stylesheet" media="all" href="/lib/Han/dist/han.min.css?v=3.3"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><meta name="google-site-verification" content="UGOd-4AuTAVn0sg3M96JPfTUNvXjmjV0uCNLkjuKX8Q"><meta name="baidu-site-verification" content="codeva-cs18pREvQ9"><link href="https://cdn.jsdelivr.net/gh/tonsky/FiraCode@1.206/distr/fira_code.css" rel="stylesheet" type="text/css"><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet" type="text/css"><link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css"><link rel="apple-touch-icon" sizes="180x180" href="/images/favicon.ico?v=5.1.4"><link rel="icon" type="image/png" sizes="32x32" href="/images/favicon.ico?v=5.1.4"><link rel="icon" type="image/png" sizes="16x16" href="/images/favicon.ico?v=5.1.4"><link rel="icon" type="image/png" sizes="16x16" href="/images/favicon.ico?v=5.1.4"><link rel="icon" type="image/png" sizes="16x16" href="/images/favicon.ico?v=5.1.4"><link rel="icon" type="image/png" sizes="16x16" href="/images/favicon.ico?v=5.1.4"><meta name="keywords" content="JavaScript å¼•æ“,V8,"><link rel="alternate" href="/atom.xml" title="è´ªç©º" type="application/atom+xml"><meta name="description" content="å‰è¨€æœ¬æ–‡æ˜¯æ ¹æ®è‡ªå·±çš„ç†è§£ç¿»è¯‘è€Œæ¥ï¼Œå¦‚æœ‰ç–‘æƒ‘å¯æŸ¥çœ‹åŸæ–‡ The story of a V8 performance cliff in Reactã€‚æœ¬æ¬¡æš‚å®šç¿»è¯‘ä¸‰ç¯‡æ–‡ç« ï¼šJavaScript engine fundamentals: Shapes and Inline Caches(Published 14th June 2018)JavaScript engine fundamentals: opt"><meta name="keywords" content="JavaScript å¼•æ“,V8"><meta property="og:type" content="article"><meta property="og:title" content="ã€è¯‘ã€‘The story of a V8 performance cliff in React"><meta property="og:url" content="https://yexiaochen.github.io/ã€è¯‘ã€‘The-story-of-a-V8-performance-cliff-in-React/index.html"><meta property="og:site_name" content="è´ªç©º"><meta property="og:description" content="å‰è¨€æœ¬æ–‡æ˜¯æ ¹æ®è‡ªå·±çš„ç†è§£ç¿»è¯‘è€Œæ¥ï¼Œå¦‚æœ‰ç–‘æƒ‘å¯æŸ¥çœ‹åŸæ–‡ The story of a V8 performance cliff in Reactã€‚æœ¬æ¬¡æš‚å®šç¿»è¯‘ä¸‰ç¯‡æ–‡ç« ï¼šJavaScript engine fundamentals: Shapes and Inline Caches(Published 14th June 2018)JavaScript engine fundamentals: opt"><meta property="og:locale" content="zh-Hans"><meta property="og:image" content="https://yexiaochen.github.io/images/01-javascript-types.svg"><meta property="og:image" content="https://yexiaochen.github.io/images/02-primitives-objects.svg"><meta property="og:image" content="https://yexiaochen.github.io/images/03-primitives-objects-typeof.svg"><meta property="og:image" content="https://yexiaochen.github.io/images/04-smi-vs-heapnumber.svg"><meta property="og:image" content="https://yexiaochen.github.io/images/05-update-smi.svg"><meta property="og:image" content="https://yexiaochen.github.io/images/06-update-heapnumber.svg"><meta property="og:image" content="https://yexiaochen.github.io/images/07-heapnumbers.svg"><meta property="og:image" content="https://yexiaochen.github.io/images/08-garbage-heapnumbers.svg"><meta property="og:image" content="https://yexiaochen.github.io/images/09-mutableheapnumber.svg"><meta property="og:image" content="https://yexiaochen.github.io/images/10-update-mutableheapnumber.svg"><meta property="og:image" content="https://yexiaochen.github.io/images/11-mutableheapnumber-to-heapnumber.svg"><meta property="og:image" content="https://yexiaochen.github.io/images/12-smi-no-boxing.svg"><meta property="og:image" content="https://yexiaochen.github.io/images/13-shape.svg"><meta property="og:image" content="https://yexiaochen.github.io/images/14-shape-transition.svg"><meta property="og:image" content="https://yexiaochen.github.io/images/15-shape-deprecation.svg"><meta property="og:image" content="https://yexiaochen.github.io/images/16-split-shape.svg"><meta property="og:image" content="https://yexiaochen.github.io/images/17-shape-nonextensible.svg"><meta property="og:image" content="https://yexiaochen.github.io/images/18-repro-shape-setup.svg"><meta property="og:image" content="https://yexiaochen.github.io/images/19-orphaned-shape.svg"><meta property="og:image" content="https://yexiaochen.github.io/images/20-fibernode-shape.svg"><meta property="og:image" content="https://yexiaochen.github.io/images/21-orphan-islands.svg"><meta property="og:image" content="https://yexiaochen.github.io/images/22-fix.svg"><meta property="og:image" content="https://yexiaochen.github.io/images/23-fix-fibernode-shape-1.svg"><meta property="og:image" content="https://yexiaochen.github.io/images/24-fix-fibernode-shape-2.svg"><meta property="og:updated_time" content="2019-11-26T14:10:07.989Z"><meta name="twitter:card" content="summary"><meta name="twitter:title" content="ã€è¯‘ã€‘The story of a V8 performance cliff in React"><meta name="twitter:description" content="å‰è¨€æœ¬æ–‡æ˜¯æ ¹æ®è‡ªå·±çš„ç†è§£ç¿»è¯‘è€Œæ¥ï¼Œå¦‚æœ‰ç–‘æƒ‘å¯æŸ¥çœ‹åŸæ–‡ The story of a V8 performance cliff in Reactã€‚æœ¬æ¬¡æš‚å®šç¿»è¯‘ä¸‰ç¯‡æ–‡ç« ï¼šJavaScript engine fundamentals: Shapes and Inline Caches(Published 14th June 2018)JavaScript engine fundamentals: opt"><meta name="twitter:image" content="https://yexiaochen.github.io/images/01-javascript-types.svg"><script type="text/javascript" id="hexo.configurations">var NexT=window.NexT||{},CONFIG={root:"/",scheme:"Mist",version:"5.1.4",sidebar:{position:"left",display:"hide",offset:12,b2t:!1,scrollpercent:!1,onmobile:!0},fancybox:!1,tabs:!0,motion:{enable:!1,async:!1,transition:{post_block:"fadeIn",post_header:"slideDownIn",post_body:"slideDownIn",coll_header:"slideLeftIn",sidebar:"slideUpIn"}},duoshuo:{userId:"0",author:"åšä¸»"},algolia:{applicationID:"",apiKey:"",indexName:"",hits:{per_page:10},labels:{input_placeholder:"Search for Posts",hits_empty:"We didn't find any results for the search: ${query}",hits_stats:"${hits} results found in ${time} ms"}}}</script><link rel="canonical" href="https://yexiaochen.github.io/ã€è¯‘ã€‘The-story-of-a-V8-performance-cliff-in-React/"><title>ã€è¯‘ã€‘The story of a V8 performance cliff in React | è´ªç©º</title><script type="text/javascript">var _hmt=_hmt||[];!function(){var e=document.createElement("script");e.src="https://hm.baidu.com/hm.js?7503c6e413a2a7205320ec2396c811d0";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)}()</script></head><body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans"><div class="container sidebar-position-left page-post-detail"><div class="headband"></div><header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="header-inner"><div class="site-brand-wrapper"><div class="site-meta"><div class="custom-logo-site-title"><a href="/" class="brand" rel="start"><span class="logo-line-before"><i></i></span> <span class="site-title">è´ªç©º</span> <span class="logo-line-after"><i></i></span></a></div><h1 class="site-subtitle" itemprop="description">è´ªç©º Blog</h1></div><div class="site-nav-toggle"><button><span class="btn-bar"></span> <span class="btn-bar"></span> <span class="btn-bar"></span></button></div></div><nav class="site-nav"><ul id="menu" class="menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i><br>é¦–é¡µ</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="menu-item-icon fa fa-fw fa-tags"></i><br>æ ‡ç­¾</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="menu-item-icon fa fa-fw fa-th"></i><br>åˆ†ç±»</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="menu-item-icon fa fa-fw fa-archive"></i><br>å½’æ¡£</a></li></ul></nav></div></header><main id="main" class="main"><div class="main-inner"><div class="content-wrap"><div id="content" class="content"><div id="posts" class="posts-expand"><article class="post post-type-normal" itemscope itemtype="http://schema.org/Article"><div class="post-block"><link itemprop="mainEntityOfPage" href="https://yexiaochen.github.io/ã€è¯‘ã€‘The-story-of-a-V8-performance-cliff-in-React/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="name" content="è´ªç©º"><meta itemprop="description" content><meta itemprop="image" content="/images/avatar.jpeg"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="è´ªç©º"></span><header class="post-header"><h2 class="post-title" itemprop="name headline">ã€è¯‘ã€‘The story of a V8 performance cliff in React</h2><div class="post-meta"><span class="post-time"><span class="post-meta-item-icon"><i class="fa fa-calendar-o"></i> </span><span class="post-meta-item-text">å‘è¡¨äº</span> <time title="åˆ›å»ºäº" itemprop="dateCreated datePublished" datetime="2019-09-29T21:35:57+08:00">2019-09-29 </time><span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="fa fa-calendar-check-o"></i> </span><span class="post-meta-item-text">æ›´æ–°äº&#58;</span> <time title="æ›´æ–°äº" itemprop="dateModified" datetime="2019-11-26T22:10:07+08:00">2019-11-26 </time></span><span class="post-category"><span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="fa fa-folder-o"></i> </span><span class="post-meta-item-text">åˆ†ç±»äº</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/æµè§ˆå™¨/" itemprop="url" rel="index"><span itemprop="name">æµè§ˆå™¨</span></a></span></span><div class="post-wordcount"><span class="post-meta-item-icon"><i class="fa fa-file-word-o"></i> </span><span class="post-meta-item-text">å­—æ•°ç»Ÿè®¡&#58;</span> <span title="å­—æ•°ç»Ÿè®¡">4,070 å­— </span><span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="fa fa-clock-o"></i> </span><span class="post-meta-item-text">é˜…è¯»æ—¶é•¿ &asymp;</span> <span title="é˜…è¯»æ—¶é•¿">17 åˆ†é’Ÿ</span></div></div></header><div class="post-body han-init-context" itemprop="articleBody"><h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>æœ¬æ–‡æ˜¯æ ¹æ®è‡ªå·±çš„ç†è§£ç¿»è¯‘è€Œæ¥ï¼Œå¦‚æœ‰ç–‘æƒ‘å¯æŸ¥çœ‹åŸæ–‡ <a href="https://v8.dev/blog/react-cliff" rel="external nofollow noopener noreferrer" target="_blank">The story of a V8 performance cliff in React</a>ã€‚</p><p>æœ¬æ¬¡æš‚å®šç¿»è¯‘ä¸‰ç¯‡æ–‡ç« ï¼š</p><ol><li><a href="https://mathiasbynens.be/notes/shapes-ics" rel="external nofollow noopener noreferrer" target="_blank">JavaScript engine fundamentals: Shapes and Inline Caches</a>(Published 14th June 2018)</li><li><a href="https://mathiasbynens.be/notes/prototypes" rel="external nofollow noopener noreferrer" target="_blank">JavaScript engine fundamentals: optimizing prototypes</a>(Published 16th August 2018)</li><li><a href="https://v8.dev/blog/react-cliff" rel="external nofollow noopener noreferrer" target="_blank">The story of a V8 performance cliff in React</a>(Published 28 August 2019)</li></ol><h2 id="JavaScript-types"><a href="#JavaScript-types" class="headerlink" title="JavaScript types"></a>JavaScript types</h2><p>åœ¨ JavaScript ä¸­ï¼Œå€¼æœ‰ 8 æ€»ç±»å‹ï¼ˆå½“å‰ï¼‰ï¼š<code>Number</code>ï¼Œ<code>String</code>ï¼Œ<code>Symbol</code>ï¼Œ<code>BigInt</code>ï¼Œ<code>Boolean</code>ï¼Œ<code>Undefined</code>ï¼Œ<code>Null</code>ï¼Œ<code>Object</code>ã€‚</p><p><img src="../images/01-javascript-types.svg" alt="01-javascript-types" title="01-javascript-types"></p><p>é™¤äº†ä¸€ä¸ªæ˜æ˜¾çš„ä¾‹å¤–ï¼Œè¿™äº›ç±»å‹éƒ½å¯ä»¥ç”¨ <code>typeof</code> ç›´æ¥æŸ¥çœ‹ã€‚</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typeof</span> <span class="number">42</span>;</span><br><span class="line"><span class="comment">// â†’ 'number'</span></span><br><span class="line"><span class="keyword">typeof</span> <span class="string">'foo'</span>;</span><br><span class="line"><span class="comment">// â†’ 'string'</span></span><br><span class="line"><span class="keyword">typeof</span> <span class="built_in">Symbol</span>(<span class="string">'bar'</span>);</span><br><span class="line"><span class="comment">// â†’ 'symbol'</span></span><br><span class="line"><span class="keyword">typeof</span> <span class="number">42n</span>;</span><br><span class="line"><span class="comment">// â†’ 'bigint'</span></span><br><span class="line"><span class="keyword">typeof</span> <span class="literal">true</span>;</span><br><span class="line"><span class="comment">// â†’ 'boolean'</span></span><br><span class="line"><span class="keyword">typeof</span> <span class="literal">undefined</span>;</span><br><span class="line"><span class="comment">// â†’ 'undefined'</span></span><br><span class="line"><span class="keyword">typeof</span> <span class="literal">null</span>;</span><br><span class="line"><span class="comment">// â†’ 'object' ğŸ¤”</span></span><br><span class="line"><span class="keyword">typeof</span> &#123; <span class="attr">x</span>: <span class="number">42</span> &#125;;</span><br><span class="line"><span class="comment">// â†’ 'object'</span></span><br></pre></td></tr></table></figure><p><code>typeof null</code> è¿”å›çš„æ˜¯ <code>&#39;object&#39;</code>ï¼Œè€Œä¸æ˜¯ <code>&#39;null&#39;</code>ï¼Œè¦äº†è§£ä¸ºä»€ä¹ˆï¼Œé¦–å…ˆè¦æŠŠæ‰€æœ‰çš„ JavaScript ç±»å‹åˆ†æˆä¸¤ç»„ï¼š</p><ul><li>objects(å³ï¼Œå¯¹è±¡ç±»å‹)</li><li>primitives(å³ï¼Œéå¯¹è±¡ç±»å‹)</li></ul><p>ç…§æ­¤æ¥è¯´ï¼Œ<code>null</code> è¡¨ç¤ºã€Œæ²¡æœ‰å¯¹è±¡ã€ï¼Œè€Œ <code>undefined</code> è¡¨ç¤º ã€Œæ²¡æœ‰å€¼ã€ã€‚</p><p><img src="../images/02-primitives-objects.svg" alt="02-primitives-objects" title="02-primitives-objects"></p><p>æŒ‰ç…§è¿™ä¸ªæ€è·¯ï¼ŒBrendan Eich åœ¨è®¾è®¡ JavaScript æ—¶ï¼Œå—åˆ° Java çš„å½±å“ï¼Œä½¿å¾—å³æ‰‹è¾¹çš„å€¼æ‰§è¡Œ <code>typeof</code> åéƒ½è¿”å› <code>object</code>ã€‚å› æ­¤ï¼Œå³ä¾¿è§„èŒƒé‡Œæœ‰ <code>Null</code> ç±»å‹ï¼Œ<code>typeof null === &#39;object&#39;</code> ä¾ç„¶æˆç«‹ã€‚</p><p><img src="../images/03-primitives-objects-typeof.svg" alt="03-primitives-objects-typeof" title="03-primitives-objects-typeof"></p><h2 id="Value-representation"><a href="#Value-representation" class="headerlink" title="Value representation"></a>Value representation</h2><p>JavaScript å¼•æ“èƒ½å¤Ÿåœ¨å†…å­˜ä¸­è¡¨ç¤ºä»»æ„çš„ JavaScript å€¼ã€‚ç„¶è€Œï¼Œå€¼å¾—æ³¨æ„çš„æ˜¯ï¼ŒJavaScript å¼•æ“åœ¨å†…å­˜ä¸­å€¼ç±»å‹çš„è¡¨ç°å½¢å¼æ˜¯ä¸åŒäº JavaScript ä¸­çš„ç±»å‹æè¿°ã€‚</p><p>ä¾‹å¦‚ï¼Œ42ï¼Œåœ¨ JavaScript ä¸­æ˜¯ <code>number</code> ç±»å‹ã€‚</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typeof</span> <span class="number">42</span>;</span><br><span class="line"><span class="comment">// â†’ 'number'</span></span><br></pre></td></tr></table></figure><p>åœ¨å†…å­˜ä¸­æœ‰å¥½å¤šç§æ–¹å¼è¡¨ç¤ºæ•´æ•°ï¼Œä¾‹å¦‚ 42:</p><table><thead><tr><th style="text-align:center">representation</th><th style="text-align:center">bits</th></tr></thead><tbody><tr><td style="text-align:center">twoâ€™s complement 8-bit</td><td style="text-align:center"><code>0010 1010</code></td></tr><tr><td style="text-align:center">twoâ€™s complement 32-bit</td><td style="text-align:center"><code>0000 0000 0000 0000 0000 0000 0010 1010</code></td></tr><tr><td style="text-align:center">packed binary-coded decimal (BCD)</td><td style="text-align:center"><code>0100 0010</code></td></tr><tr><td style="text-align:center">32-bit IEEE-754 floating-point</td><td style="text-align:center"><code>0100 0010 0010 1000 0000 0000 0000 0000</code></td></tr><tr><td style="text-align:center">64-bit IEEE-754 floating-point</td><td style="text-align:center"><code>0100 0000 0100 0101 0000 0000 0000 0000 0000 0000 0000 0000 0000 0000 0000 0000</code></td></tr></tbody></table><p>ECMAScript å°†æ•°å­—æ ‡å‡†åŒ–ä¸º 64 ä½æµ®ç‚¹å€¼ï¼Œä¹Ÿç§°ä¸ºåŒç²¾åº¦æµ®ç‚¹æˆ– Float64ã€‚ä½†æ˜¯ï¼Œè¿™å¹¶ä¸æ„å‘³ç€ JavaScript å¼•æ“æ€»æ˜¯ä»¥ Float64 çš„å½¢å¼å­˜å‚¨æ•°å­— â€”â€” è¿™ä¹ˆåšä¼šå¾ˆä½æ•ˆã€‚å¼•æ“ä¼šé€‰æ‹©å…¶å®ƒçš„å†…éƒ¨è¡¨ç°å½¢å¼ï¼Œé™¤éè§‚æµ‹åˆ°çš„è¡Œä¸ºå®Œå…¨åŒ¹é… Float64ã€‚</p><p>åœ¨çœŸå®çš„ JavaScript åº”ç”¨ä¸­ï¼Œå¤§å¤šæ•°æ•°å­—éƒ½æ˜¯åˆæ³•çš„ ECMAScript <a href="https://tc39.es/ecma262/#array-index" rel="external nofollow noopener noreferrer" target="_blank">æ•°ç»„ç´¢å¼•</a>ï¼Œå³ï¼Œå±äº 0 ~ 2Â³Â²âˆ’2 èŒƒå›´å†…çš„æ•´æ•°ã€‚</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">array[<span class="number">0</span>]; <span class="comment">// Smallest possible array index.</span></span><br><span class="line">array[<span class="number">42</span>];</span><br><span class="line">array[<span class="number">2</span>**<span class="number">32</span><span class="number">-2</span>]; <span class="comment">// Greatest possible array index.</span></span><br></pre></td></tr></table></figure><p>JavaScript å¼•æ“ä¼šä¸ºæ•°å­—é€‰æ‹©æœ€ä¼˜å­˜å‚¨çš„è¡¨è¾¾å½¢å¼ä»¥æ­¤ä¼˜åŒ–æ•°ç»„å…ƒç´ çš„è®¿é—®æ•ˆç‡ã€‚å¯¹äºå¤„ç†å™¨çš„å†…å­˜è®¿é—®æ“ä½œï¼Œæ•°ç»„ç´¢å¼•å¿…é¡»æ˜¯äºŒè¿›åˆ¶è¡¥ç çš„å½¢å¼ã€‚ç”¨ Float64 è¡¨ç¤ºæ•°ç»„æ˜¯ä¸€ç§å¾ˆè´¹æ€§èƒ½çš„è¡Œä¸ºï¼Œå› ä¸ºæ¯æ¬¡è®¿é—®æ•°ç»„å…ƒç´ å¼•æ“éƒ½éœ€è¦åœ¨ Float64 å’ŒäºŒè¿›åˆ¶è¡¥ç ä¹‹é—´è½¬æ¢ã€‚</p><p>32 ä½çš„äºŒè¿›åˆ¶è¡¥ç è¡¨è¾¾å½¢å¼å¯¹æ•°ç»„æ“ä½œæ˜¯å¾ˆæœ‰ç”¨çš„ã€‚é€šå¸¸æ¥è¯´ï¼Œå¤„ç†å™¨æ‰§è¡Œæ•´å‹æ“ä½œæ¯”æ‰§è¡Œæµ®ç‚¹å‹æ“ä½œè¦å¿«å¾—å¤šã€‚æ‰€ä»¥è¯´ï¼Œä¸‹é¢çš„ä¾‹å­ï¼Œç¬¬ä¸€ä¸ªå¾ªç¯æ¯”ç¬¬äºŒä¸ªå¾ªç¯å¿«ä¸¤å€ã€‚</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; <span class="number">1000</span>; ++i) &#123;</span><br><span class="line">  <span class="comment">// fast ğŸš€</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0.1</span>; i &lt; <span class="number">1000.1</span>; ++i) &#123;</span><br><span class="line">  <span class="comment">// slow ğŸŒ</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ“ä½œç¬¦ä¹Ÿæ˜¯ä¸€æ ·ã€‚åœ¨ä¸‹é¢çš„ä»£ç ä¸­ï¼Œæ¨¡è¿ç®—ç¬¦çš„æ€§èƒ½å–å†³äºå¤„ç†çš„æ˜¯å¦æ˜¯æ•´æ•°ã€‚</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> remainder = value % divisor;</span><br><span class="line"><span class="comment">// Fast ğŸš€ if `value` and `divisor` are represented as integers,</span></span><br><span class="line"><span class="comment">// slow ğŸŒ otherwise.</span></span><br></pre></td></tr></table></figure><p>å¦‚æœä¸¤ä¸ªæ“ä½œæ•°éƒ½æ˜¯æ•´æ•°çš„å½¢å¼ï¼ŒCPU å°±å¯ä»¥é«˜æ•ˆåœ°è®¡ç®—å‡ºç»“æœã€‚å¦‚æœé™¤æ•°æ˜¯ 2 çš„å€æ•°ï¼ŒV8 è¿˜ä¼šæœ‰é¢å¤–çš„æ·å¾„ã€‚å¯¹äºå€¼æ˜¯æµ®ç‚¹å‹çš„å½¢å¼ï¼Œè®¡ç®—è¿‡ç¨‹ä¼šå˜å¾—å¤æ‚è€—æ—¶ã€‚</p><p>å› ä¸ºæ•´å‹æ“ä½œçš„æ‰§è¡Œé€Ÿåº¦é€šå¸¸æ¯”æµ®ç‚¹å‹è¦å¿«å¾ˆå¤šï¼Œæ‰€ä»¥ï¼Œå¼•æ“å°±åº”è¯¥ä½¿ç”¨äºŒè¿›åˆ¶è¡¥ç æ¥è¡¨ç¤ºæ‰€æœ‰çš„æ•´å‹å’Œæ•´å‹æ“ä½œçš„ç»“æœã€‚é—æ†¾çš„æ˜¯ï¼Œé‚£æ˜¯æœ‰æ‚–äº ECMAScript è§„èŒƒçš„ï¼ECMAScript é‡‡ç”¨äº† Float64ï¼ŒæŸäº›æ•´æ•°è¿ç®—å®é™…ä¸Šäº§ç”Ÿçš„æ˜¯æµ®ç‚¹å‹ã€‚åœ¨ä¸‹é¢è¿™ç§æƒ…å†µä¸‹ï¼Œå¯¹äºèƒ½å¤Ÿäº§ç”Ÿæ­£ç¡®çš„ç»“æœå¾ˆé‡è¦ã€‚</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Float64 has a safe integer range of 53 bits. Beyond that range,</span></span><br><span class="line"><span class="comment">// you must lose precision.</span></span><br><span class="line"><span class="number">2</span>**<span class="number">53</span> === <span class="number">2</span>**<span class="number">53</span>+<span class="number">1</span>;</span><br><span class="line"><span class="comment">// â†’ true</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Float64 supports negative zeros, so -1 * 0 must be -0, but</span></span><br><span class="line"><span class="comment">// thereâ€™s no way to represent negative zero in twoâ€™s complement.</span></span><br><span class="line"><span class="number">-1</span>*<span class="number">0</span> === <span class="number">-0</span>;</span><br><span class="line"><span class="comment">// â†’ true</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Float64 has infinities which can be produced through division</span></span><br><span class="line"><span class="comment">// by zero.</span></span><br><span class="line"><span class="number">1</span>/<span class="number">0</span> === <span class="literal">Infinity</span>;</span><br><span class="line"><span class="comment">// â†’ true</span></span><br><span class="line"><span class="number">-1</span>/<span class="number">0</span> === -<span class="literal">Infinity</span>;</span><br><span class="line"><span class="comment">// â†’ true</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Float64 also has NaNs.</span></span><br><span class="line"><span class="number">0</span>/<span class="number">0</span> === <span class="literal">NaN</span>;</span><br></pre></td></tr></table></figure><p>å·¦è¾¹çš„å€¼éƒ½æ˜¯æ•´å‹ï¼Œè€Œå³è¾¹çš„å´æ˜¯æµ®ç‚¹å‹ã€‚ä»¥ä¸Šçš„æ“ä½œåœ¨ä½¿ç”¨ 32 ä½äºŒè¿›åˆ¶è¡¥ç çš„å½¢å¼æ˜¯æ²¡æ³•æ­£ç¡®æ‰§è¡Œçš„ã€‚JavaScript å¼•æ“å¿…é¡»ç¡®ä¿æ•´å‹æ“ä½œè¢«åˆç†åœ°å¤„ç†ä»¥ç”Ÿæˆæƒ³è¦çš„ Float64 ç»“æœã€‚</p><p>å¯¹äºåœ¨ 31 ä½æœ‰ç¬¦å·æ•´æ•°èŒƒå›´å†…çš„å°æ•´æ•°ï¼ŒV8 æœ‰ç‰¹æ®Šçš„è¡¨ç¤ºå½¢å¼ï¼Œç§°ä¸º Smiã€‚å¯¹äºé Smi çš„æ•°å€¼ä¼šè¢«è¡¨ç¤ºä¸º HeapObjectï¼Œå®ƒæ˜¯å†…å­˜ä¸­æŸäº›å®ä½“çš„åœ°å€ã€‚æˆ‘ä»¬ä½¿ç”¨ä¸€ç§ç‰¹æ®Šçš„ HeapObjectï¼Œå³æ‰€è°“çš„ HeapNumberï¼Œæ¥è¡¨ç¤ºè¶…å‡º Smi èŒƒå›´çš„æ•°å­—ã€‚</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"> -<span class="literal">Infinity</span> <span class="comment">// HeapNumber</span></span><br><span class="line">-(<span class="number">2</span>**<span class="number">30</span>)<span class="number">-1</span> <span class="comment">// HeapNumber</span></span><br><span class="line">  -(<span class="number">2</span>**<span class="number">30</span>) <span class="comment">// Smi</span></span><br><span class="line">       <span class="number">-42</span> <span class="comment">// Smi</span></span><br><span class="line">        <span class="number">-0</span> <span class="comment">// HeapNumber</span></span><br><span class="line">         <span class="number">0</span> <span class="comment">// Smi</span></span><br><span class="line">       <span class="number">4.2</span> <span class="comment">// HeapNumber</span></span><br><span class="line">        <span class="number">42</span> <span class="comment">// Smi</span></span><br><span class="line">   <span class="number">2</span>**<span class="number">30</span><span class="number">-1</span> <span class="comment">// Smi</span></span><br><span class="line">     <span class="number">2</span>**<span class="number">30</span> <span class="comment">// HeapNumber</span></span><br><span class="line">  <span class="literal">Infinity</span> <span class="comment">// HeapNumber</span></span><br><span class="line">       <span class="literal">NaN</span> <span class="comment">// HeapNumber</span></span><br></pre></td></tr></table></figure><p>å¦‚ä¸Šæ‰€ç¤ºï¼ŒæŸäº›æ•°å­—è¢«è¡¨ç¤ºä¸º Smiï¼Œå…¶å®ƒæ•°å­—è¢«è¡¨ç¤ºä¸º HeapNumberã€‚V8 å¯¹ Smi ä¸“é—¨ä¼˜åŒ–ï¼Œå› ä¸ºåœ¨çœŸå®çš„ JavaScript ç¼–ç¨‹ä¸­ï¼Œå°çš„æ•´æ•°æ˜¯éå¸¸æ™®éçš„ã€‚Smi æ²¡å¿…è¦åœ¨å†…å­˜ä¸­åˆ†é…ä¸“ç”¨çš„å®ä½“ï¼Œè€Œä¸”å¯ä»¥ç´ å¿«é€Ÿåœ°æ•´å‹æ“ä½œã€‚</p><h2 id="Smi-vs-HeapNumber-vs-MutableHeapNumber"><a href="#Smi-vs-HeapNumber-vs-MutableHeapNumber" class="headerlink" title="Smi vs. HeapNumber vs. MutableHeapNumber"></a>Smi vs. HeapNumber vs. MutableHeapNumber</h2><p>æœ‰ä»¥ä¸‹å¯¹è±¡ï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> o = &#123;</span><br><span class="line">  x: <span class="number">42</span>,  <span class="comment">// Smi</span></span><br><span class="line">  y: <span class="number">4.2</span>, <span class="comment">// HeapNumber</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>x çš„å€¼ 42 è¢«ç¼–ç¨‹ä¸º Smiï¼Œå› æ­¤å®ƒè¢«å­˜å‚¨åœ¨å¯¹è±¡é‡Œã€‚å¦ä¸€æ–¹é¢å€¼ 4.2 éœ€è¦ä¸€ä¸ªç‹¬ç«‹çš„å®ä¾‹ï¼ˆç©ºé—´ï¼‰æ¥ä¿å­˜è¿™ä¸ªå€¼ï¼Œå¹¶ä¸”è¿™ä¸ªå¯¹è±¡ä¼šæŒ‡å‘è¿™ä¸ªå®ä½“ã€‚</p><p><img src="../images/04-smi-vs-heapnumber.svg" alt="04-smi-vs-heapnumber" title="04-smi-vs-heapnumber"></p><p>è¿è¡Œä»¥ä¸‹ JavaScript ä»£ç ç‰‡æ®µï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">o.x += <span class="number">10</span>;</span><br><span class="line"><span class="comment">// â†’ o.x is now 52</span></span><br><span class="line">o.y += <span class="number">1</span>;</span><br><span class="line"><span class="comment">// â†’ o.y is now 5.2</span></span><br></pre></td></tr></table></figure><p>è¿™ç§æƒ…å†µä¸‹ï¼Œx çš„å€¼å¯ä»¥å°±åœ°æ›´æ–°ï¼Œå› ä¸ºæ–°çš„å€¼ 52 ä¹Ÿåœ¨ Smi çš„èŒƒå›´å†…ã€‚</p><p><img src="../images/05-update-smi.svg" alt="05-update-smi" title="05-update-smi"></p><p>ç„¶è€Œï¼Œæ–°çš„å€¼ <code>y=5.2</code> ä¸åœ¨ Smi èŒƒå›´å†…ä¸”ä¸åŒäºä¹‹å‰çš„å€¼ 4.2ï¼Œå› æ­¤ V8 ä¸º y é‡æ–°åˆ†é…äº†æ–°çš„ HeapNumber å®ä½“ã€‚</p><p><img src="../images/06-update-heapnumber.svg" alt="06-update-heapnumber" title="06-update-heapnumber"></p><p>HeapNumber æ˜¯ä¸å¯å˜çš„ï¼Œå®ƒä½¿å¾—æŸäº›ä¼˜åŒ–æˆä¸ºå¯èƒ½ã€‚ä¾‹å¦‚ï¼Œæˆ‘ä»¬æŠŠ y èµ‹å€¼ç»™ xï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">o.x = o.y;</span><br><span class="line"><span class="comment">// â†’ o.x is now 5.2</span></span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬åªéœ€è¦æŠŠå®ƒè¿æ¥åˆ°åŒä¸€ä¸ª HeapNumber ä¸Šè€Œä¸æ˜¯é‡æ–°åˆ†é…ä¸€ä¸ªæ–°çš„å®ä½“ï¼ˆç©ºé—´ï¼‰ã€‚</p><p><img src="../images/07-heapnumbers.svg" alt="07-heapnumbers" title="07-heapnumbers"></p><p>HeapNumber ä¸å¯å˜ä¹Ÿå­˜åœ¨ç¼ºç‚¹ï¼Œå¦‚æœæ›´æ–°çš„å€¼ç»å¸¸ä¸åœ¨ Smi çš„èŒƒå›´å†…ï¼Œå®ƒå°±ä¼šå˜æ…¢ï¼Œä¾‹å¦‚ä¸‹é¢çš„ä¾‹å­ï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Create a `HeapNumber` instance.</span></span><br><span class="line"><span class="keyword">const</span> o = &#123; <span class="attr">x</span>: <span class="number">0.1</span> &#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; <span class="number">5</span>; ++i) &#123;</span><br><span class="line">  <span class="comment">// Create an additional `HeapNumber` instance.</span></span><br><span class="line">  o.x += <span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç¬¬ä¸€è¡Œåˆ›å»ºäº†ä¸€ä¸ª HeapNumber å®ä¾‹ï¼Œå…¶åˆå§‹å€¼ä¸º 0.1ã€‚åœ¨å¾ªç¯ä½“ä¸­å€¼ä» 1.1ï¼Œ2.1ï¼Œ3.1ï¼Œ4.2 å˜åˆ° 5.1ï¼Œä¸€å…±åˆ›å»ºäº† 6 ä¸ª HeapNumber å®ä¾‹ï¼Œå…¶ä¸­ 5 ä¸ªä¼šåœ¨å¾ªç¯ç»“æŸåå˜æ²¡æœ‰ä»»ä½•ç”¨å¤„ã€‚</p><p><img src="../images/08-garbage-heapnumbers.svg" alt="08-garbage-heapnumbers" title="08-garbage-heapnumbers"></p><p>ä¸ºäº†é¿å…è¿™ç§æƒ…å†µï¼Œä½œä¸ºä¼˜åŒ–ï¼ŒV8 æä¾›äº†å°±åœ°æ›´æ–°é Smi æ•°å€¼çš„æ–¹æ³•ã€‚å½“ä¸€ä¸ªå­—æ®µå¯¹åº”ç€é Smi çš„æ•°å€¼ï¼ŒV8 ä¼šåœ¨ shape ä¸Šå°†è¿™ä¸ªå­—æ®µæ ‡è®°ä¸º Doubleï¼Œå¹¶åˆ†é…ä¸€ä¸ªä¿å­˜ Float64 çš„ MutableHeapNumber å®ä½“ã€‚</p><p><img src="../images/09-mutableheapnumber.svg" alt="09-mutableheapnumber" title="09-mutableheapnumber"></p><p>å½“å­—æ®µé‡Œçš„å€¼å‘ç”Ÿå˜åŒ–æ—¶ï¼ŒV8 ä¸å¿…åˆ†é…ä¸€ä¸ªæ–°çš„ HeapNumberï¼Œè€Œæ˜¯åœ¨ MutableHeapNumber å®ä½“ä¸­å°±åœ°æ›´æ–°ã€‚</p><p><img src="../images/10-update-mutableheapnumber.svg" alt="10-update-mutableheapnumber" title="10-update-mutableheapnumber"></p><p>ç„¶è€Œï¼Œéœ€è¦æ³¨æ„çš„æ˜¯ï¼ŒMutableHeapNumber ä¸­çš„å€¼æ˜¯å¯ä»¥æ”¹å˜çš„ï¼Œæ‰€ä»¥å€¼ä¸åº”è¯¥ä¼ æ¥ä¼ å»çš„ã€‚</p><p><img src="../images/11-mutableheapnumber-to-heapnumber.svg" alt="11-mutableheapnumber-to-heapnumber" title="11-mutableheapnumber-to-heapnumber"></p><p>ä¾‹å¦‚ï¼Œä½ æŠŠ <code>o.x</code> èµ‹å€¼ç»™å˜é‡ yï¼Œä½ ä¸å¸Œæœ› y ä¼šéšç€ <code>o.x</code> çš„æ”¹å˜è€Œæ”¹å˜ï¼æ‰€ä»¥åœ¨ç»™ y èµ‹å€¼å‰ï¼Œå¿…é¡»å°† <code>o.x</code> çš„å€¼é‡æ–°åŒ…è£…æˆ HeapNumberã€‚</p><p>å¯¹äºæµ®ç‚¹å‹ï¼ŒV8 å·²ç»é»˜é»˜åœ°åŒ…è£…äº†ä¸€ä¸‹ã€‚ä½†æ˜¯ï¼Œå¯¹äºå°çš„æ•´æ•°ä¹Ÿé‡‡ç”¨å’Œ MutableHeapNumber ç›¸åŒçš„æ–¹æ³•ï¼Œå°±ä¼šæ˜¾å¾—æµªè´¹ï¼Œå› ä¸º Smi æœ¬å°±æ˜¯ä¸€ç§æ›´é«˜æ•ˆçš„è¡¨ç°å½¢å¼ã€‚</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> object = &#123; <span class="attr">x</span>: <span class="number">1</span> &#125;;</span><br><span class="line"><span class="comment">// â†’ no â€œboxingâ€ for `x` in object</span></span><br><span class="line"></span><br><span class="line">object.x += <span class="number">1</span>;</span><br><span class="line"><span class="comment">// â†’ update the value of `x` inside object</span></span><br></pre></td></tr></table></figure><p>ä¸ºäº†é¿å…ä½æ•ˆç‡ï¼Œæˆ‘ä»¬ä¼šåœ¨ shape ä¸Šä¸ºå°æ•´æ•°å¯¹åº”çš„å­—æ®µä¸Šæ ‡è®° Smiï¼Œå¹¶ä¸”ä¼šåŸåœ°æ›´æ–°æ•°å€¼ï¼Œåªè¦è¿™ä¸ªæ•°å€¼åœ¨ Smi èŒƒå›´å†…ã€‚</p><p><img src="../images/12-smi-no-boxing.svg" alt="12-smi-no-boxing" title="12-smi-no-boxing"></p><h2 id="Shape-deprecations-and-migrations"><a href="#Shape-deprecations-and-migrations" class="headerlink" title="Shape deprecations and migrations"></a>Shape deprecations and migrations</h2><p>å¦‚æœä¸€ä¸ªå­—æ®µé‡ŒåŒ…å«çš„å€¼åœ¨ Smi èŒƒå›´å†…ï¼Œä¹‹ååˆä¸å±äº Smi èŒƒå›´ï¼Œè¿™ä¸­é—´å‘ç”Ÿäº†ä»€ä¹ˆï¼Ÿç°æœ‰ä¸¤ä¸ªå¯¹è±¡ï¼Œå®ƒä»¬çš„ x å±æ€§å€¼éƒ½æ˜¯ Smi è¡¨ç¤ºå½¢å¼ã€‚</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> a = &#123; <span class="attr">x</span>: <span class="number">1</span> &#125;;</span><br><span class="line"><span class="keyword">const</span> b = &#123; <span class="attr">x</span>: <span class="number">2</span> &#125;;</span><br><span class="line"><span class="comment">// â†’ objects have `x` as `Smi` field now</span></span><br><span class="line"></span><br><span class="line">b.x = <span class="number">0.2</span>;</span><br><span class="line"><span class="comment">// â†’ `b.x` is now represented as a `Double`</span></span><br><span class="line"></span><br><span class="line">y = a.x;</span><br></pre></td></tr></table></figure><p>è¿™ä¸¤ä¸ªå¯¹è±¡éƒ½æŒ‡å‘åŒä¸€ä¸ª shapeï¼Œx å±æ€§ç‰¹æ€§ Representation è¢«æ ‡è®°ä¸º Smiï¼š</p><p><img src="../images/13-shape.svg" alt="13-shape" title="13-shape"></p><p>å½“ <code>b.x</code> å˜æˆ Double å½¢å¼ï¼ŒV8 ä¼šåˆ›å»ºä¸€ä¸ªæ–°çš„ shapeï¼Œå±æ€§ x çš„ Representation è¢«æ ‡è®°ä¸º Double ä¸”æŒ‡å‘ä¹‹å‰çš„ç©º shapeã€‚V8 ä¹Ÿä¼šä¸ºå±æ€§ x åˆ†é…ä¸€ä¸ª MutableHeapNumber å®ä½“ç”¨æ¥ä¿å­˜å€¼ 0.2ã€‚ç„¶åè®©å¯¹è±¡ b æŒ‡å‘æ–°åˆ›å»ºçš„ shape å¹¶ä¸”å†…éƒ¨åç§»é‡ä¸º 0 çš„ä½ç½®æŒ‡å‘åˆšåˆ†é…çš„ MutableHeapNumber å®ä½“ã€‚æœ€åï¼Œæˆ‘ä»¬æŠŠæ—§çš„ shape æ ‡è®°ä¸ºåºŸå¼ƒçš„ï¼Œå¹¶æ–­å¼€ä¸è¿‡æ¸¡æ ‘ï¼ˆtransition treeï¼‰çš„é“¾æ¥ã€‚è¿™å°±å®Œæˆäº†ä»ç©º shape åˆ°æ–° shape çš„è¿‡æ¸¡ã€‚</p><p><img src="../images/14-shape-transition.svg" alt="14-shape-transition" title="14-shape-transition"></p><p>æˆ‘ä»¬ä¸èƒ½åŒæ—¶å®Œå…¨åˆ é™¤æ—§ shapeï¼Œå› ä¸ºå¯¹è±¡ a è¿˜åœ¨ä½¿ç”¨ï¼Œè€Œä¸”çŸ­æ—¶é—´æ‰¾åˆ°æ‰€æœ‰é“¾æ¥åˆ°æ—§ shape çš„å¯¹è±¡å¹¶æ›´æ–°å®ƒä»¬ï¼Œå¯¹ V8 æ¥è¯´æ˜¯ç¬”å¾ˆå¤§çš„å¼€é”€ã€‚ç›¸åï¼ŒV8 ä¸æ€¥ç€å¤„ç†ï¼šåªæœ‰åœ¨æ”¹å˜å¯¹è±¡ a çš„æ—¶å€™æ‰å¼€å§‹è¿ç§»åˆ°æ–°çš„ shapeã€‚æœ€ç»ˆï¼Œæ ‡è®°ä¸ºåºŸå¼ƒçš„ shape ä¼šæ…¢æ…¢æ·¡å‡ºè§†é‡å¹¶è¢«åƒåœ¾å›æ”¶æœºåˆ¶æŠ¹é™¤ã€‚</p><p><img src="../images/15-shape-deprecation.svg" alt="15-shape-deprecation" title="15-shape-deprecation"></p><p>æ›´æ£˜æ‰‹çš„é—®é¢˜æ˜¯ï¼Œå¦‚æœå¯¹è±¡ä¸Šå±æ€§ç‰¹æ€§ Representation å‘ç”Ÿå˜åŒ–çš„å±æ€§ä¸æ˜¯ shape é“¾ä¸Šçš„æœ€åä¸€ä¸ªï¼Œåˆä¼šå‘ç”Ÿä»€ä¹ˆå‘¢ï¼Ÿ</p><p><img src="../images/16-split-shape.svg" alt="16-split-shape" title="16-split-shape"></p><p>ä»äº§ç”Ÿåˆ†æ”¯çš„ shape å¼€å§‹ï¼Œæˆ‘ä»¬ä¸ºå±æ€§ y åˆ›å»ºäº†ä¸€ä¸ªæ–°çš„è¿‡æ¸¡é“¾ä¸” y è¢«æ ‡è®°ä¸º Doubleã€‚æˆ‘ä»¬åœ¨ä½¿ç”¨æ–°çš„è¿‡æ¸¡é“¾æ—¶ï¼Œä¹Ÿå°±æ„å‘³ç€æ—§çš„è¿‡æ¸¡é“¾å°†è¢«åºŸå¼ƒã€‚åœ¨æœ€åä¸€æ­¥ï¼Œæˆ‘ä»¬æŠŠå®ä¾‹ o è¿ç§»åˆ°æ–°çš„ shape å¹¶ç”¨ MutableHeapNumber ä¿å­˜ y çš„å€¼ã€‚å°±è¿™æ ·ï¼Œæ–°å¯¹è±¡ä¸å†ä½¿ç”¨è€çš„é‚£ä¸€å¥—ï¼Œä¸€æ—¦æ—§çš„ shape ä¸Šçš„é“¾æ¥éƒ½è¢«ç§»é™¤æ‰ï¼Œæ—§ shape ä¹Ÿä¼šä»è¿‡æ¸¡æ ‘ä¸Šæ¶ˆå¤±ã€‚</p><h2 id="Extensibility-and-integrity-level-transitions"><a href="#Extensibility-and-integrity-level-transitions" class="headerlink" title="Extensibility and integrity-level transitions"></a>Extensibility and integrity-level transitions</h2><p><code>Object.preventExtensions()</code> é˜²æ­¢å°†æ–°å±æ€§æ·»åŠ åˆ°å¯¹è±¡ä¸­ã€‚å¦‚æœä½ è¿™ä¹ˆåšäº†ï¼Œå®ƒå°†ä¼šæŠ›å¼‚å¸¸ã€‚ï¼ˆå¦‚æœæ˜¯åœ¨éä¸¥æ ¼æ¨¡å¼ä¸‹ï¼Œå®ƒä¸ä¼šæŠ›å¼‚å¸¸è€Œæ˜¯é»˜è®¤ä»€ä¹ˆéƒ½ä¸åšã€‚ï¼‰</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> object = &#123; <span class="attr">x</span>: <span class="number">1</span> &#125;;</span><br><span class="line"><span class="built_in">Object</span>.preventExtensions(object);</span><br><span class="line">object.y = <span class="number">2</span>;</span><br><span class="line"><span class="comment">// TypeError: Cannot add property y;</span></span><br><span class="line"><span class="comment">//            object is not extensible</span></span><br></pre></td></tr></table></figure><p><code>Object.seal</code> ä¸ <code>Object.preventExtensions</code> ç›¸ä¼¼ï¼Œä½†æ˜¯å®ƒä¼šæŠŠæ‰€æœ‰çš„å±æ€§æ ‡è®°ä¸ºä¸å¯é…ç½®ï¼Œè¿™å°±æ„å‘³ç€ä½ ä¸èƒ½åˆ é™¤å®ƒä»¬ï¼Œæˆ–æ”¹å˜ä»–ä»¬çš„å¯æšä¸¾æ€§ï¼Œå¯é…ç½®æ€§ï¼Œå¯å†™æ€§ã€‚</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> object = &#123; <span class="attr">x</span>: <span class="number">1</span> &#125;;</span><br><span class="line"><span class="built_in">Object</span>.seal(object);</span><br><span class="line">object.y = <span class="number">2</span>;</span><br><span class="line"><span class="comment">// TypeError: Cannot add property y;</span></span><br><span class="line"><span class="comment">//            object is not extensible</span></span><br><span class="line"><span class="keyword">delete</span> object.x;</span><br><span class="line"><span class="comment">// TypeError: Cannot delete property x</span></span><br></pre></td></tr></table></figure><p><code>Object.freeze</code> ä¸ <code>Object.seal</code> ç›¸ä¼¼ï¼Œä½†æ˜¯å®ƒå°†æ‰€æœ‰å±æ€§æ ‡è®°ä¸ºä¸å¯å†™ä»¥é˜²æ­¢å±æ€§å€¼è¢«ä¿®æ”¹ã€‚</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> object = &#123; <span class="attr">x</span>: <span class="number">1</span> &#125;;</span><br><span class="line"><span class="built_in">Object</span>.freeze(object);</span><br><span class="line">object.y = <span class="number">2</span>;</span><br><span class="line"><span class="comment">// TypeError: Cannot add property y;</span></span><br><span class="line"><span class="comment">//            object is not extensible</span></span><br><span class="line"><span class="keyword">delete</span> object.x;</span><br><span class="line"><span class="comment">// TypeError: Cannot delete property x</span></span><br><span class="line">object.x = <span class="number">3</span>;</span><br><span class="line"><span class="comment">// TypeError: Cannot assign to read-only property x</span></span><br></pre></td></tr></table></figure><p>è®©æˆ‘ä»¬æ¥æ€è€ƒä¸€ä¸ªå…·ä½“çš„ä¾‹å­ï¼Œæœ‰ä¸¤ä¸ªéƒ½åªæœ‰å±æ€§ y çš„å¯¹è±¡ï¼Œå¹¶é˜»æ­¢ç¬¬äºŒä¸ªå¯¹è±¡æœ‰ä»»ä½•çš„æ‰©å±•ã€‚</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> a = &#123; <span class="attr">x</span>: <span class="number">1</span> &#125;;</span><br><span class="line"><span class="keyword">const</span> b = &#123; <span class="attr">x</span>: <span class="number">2</span> &#125;;</span><br><span class="line"></span><br><span class="line"><span class="built_in">Object</span>.preventExtensions(b);</span><br></pre></td></tr></table></figure><p>å°±å¦‚æˆ‘ä»¬æ‰€çŸ¥çš„ï¼Œä»ç©ºçš„ shape è¿‡æ¸¡åˆ°ä¸€ä¸ªæœ‰å±æ€§ x ï¼ˆè¢«æ ‡è®°ä¸º Smiï¼‰çš„æ–° shape ä¸Šã€‚å½“æˆ‘ä»¬é˜»æ­¢ b çš„æ‰©å±•æ—¶ï¼Œæˆ‘ä»¬ä¼šè¿‡æ¸¡åˆ°æ ‡è®°ä¸ºä¸å¯æ‰©å±•çš„æ–° shape ä¸Šã€‚è¿™ä¸ªæ–° shape æ²¡æœ‰ä»»ä½•å±æ€§ï¼Œä»…ä»…ä½œä¸ºä¸€ä¸ªæ ‡è¯†ã€‚</p><p><img src="../images/17-shape-nonextensible.svg" alt="17-shape-nonextensible" title="17-shape-nonextensible"></p><p>æ³¨æ„ï¼Œæˆ‘ä»¬ä¸èƒ½å°±åœ°æ›´æ–°æœ‰ x çš„ shapeï¼Œå› ä¸ºå¯¹è±¡ a ä¾ç„¶æ˜¯å¯æ‰©å±•çš„ã€‚</p><h2 id="The-React-performance-issue"><a href="#The-React-performance-issue" class="headerlink" title="The React performance issue"></a>The React performance issue</h2><p>è®©æˆ‘ä»¬ç”¨ä»¥ä¸Šå­¦åˆ°çš„çŸ¥è¯†æ¥è§£æä¸‹ <a href="https://github.com/facebook/react/issues/14365" rel="external nofollow noopener noreferrer" target="_blank">the recent React issue #14365</a>ã€‚ç®€å•é‡ç°è¿™ä¸ª bugï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> o = &#123; <span class="attr">x</span>: <span class="number">1</span>, <span class="attr">y</span>: <span class="number">2</span> &#125;;</span><br><span class="line"><span class="built_in">Object</span>.preventExtensions(o);</span><br><span class="line">o.y = <span class="number">0.2</span>;</span><br></pre></td></tr></table></figure><p>æœ‰ä¸€ä¸ªæ‹¥æœ‰ä¸¤ä¸ªå­—æ®µçš„å¯¹è±¡ï¼Œè€Œä¸”å®ƒä»¬çš„å±æ€§ç‰¹æ€§ Representation è¢«æ ‡è®°ä¸º Smiã€‚æˆ‘ä»¬é˜»æ­¢å¯¹è±¡çš„è¿›ä¸€æ­¥æ‰©å±•ï¼Œä½†æœ€ç»ˆæˆ‘ä»¬è¿˜æ˜¯å¼ºåˆ¶æ”¹å˜ç¬¬äºŒå­—æ®µçš„å±æ€§ç‰¹æ€§ Representation çš„å€¼ï¼ˆDoubleï¼‰ã€‚</p><p>å°±å¦‚ä¹‹å‰å­¦åˆ°çš„ï¼Œå¤§è‡´æµç¨‹å¦‚ä¸‹ï¼š</p><p><img src="../images/18-repro-shape-setup.svg" alt="18-repro-shape-setup" title="18-repro-shape-setup"></p><p>æ¯ä¸ªå±æ€§çš„ç‰¹æ€§ Representation éƒ½è¢«æ ‡è®°ä¸º Smiï¼Œå¹¶æœ€ç»ˆè¿‡æ¸¡åˆ°è¢«æ ‡è®°ä¸ºä¸å¯æ‰©å±•çš„ shape ä¸Šã€‚</p><p>æˆ‘ä»¬éœ€è¦å°† y çš„å±æ€§ç‰¹æ€§ Representation æ ‡è®°ä¸º Doubleï¼Œè¿™æ„å‘³ç€æˆ‘ä»¬éœ€è¦ä»å¼•å…¥ y å±æ€§ä¹‹å‰çš„ shape å¼€å§‹ã€‚åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œå°±æ˜¯å¼•å…¥ x å±æ€§çš„é‚£ä¸ª shapeã€‚ä½†æ˜¯ï¼Œ V8 ä¼šå¾ˆå›°æƒ‘ï¼Œå› ä¸ºå½“å‰çš„ shape æ˜¯ä¸å¯æ‰©å±•çš„ï¼Œè€Œæ‰¾åˆ°çš„ shape å´æ˜¯å¯æ‰©å±•çš„ã€‚V8 ä¸çŸ¥é“æ€ä¹ˆå»å¤„ç†è¿™ä¸ªè¿‡æ¸¡æ ‘ã€‚å› æ­¤ï¼ŒV8 ä¸å†è¯•å›¾ææ¸…æ¥šè¿™äº›å…³ç³»ï¼Œè€Œæ˜¯åˆ›å»ºäº†ä¸€ä¸ªç‹¬ç«‹çš„ shapeï¼Œè¿™ä¸ª shape å’Œå…ˆå‰çš„è¿‡æ¸¡æ ‘æ²¡æœ‰ä»»ä½•å…³è”ï¼Œè€Œä¸”ä¹Ÿä¸è¢«ä»»ä½•å…¶å®ƒå¯¹è±¡å…±äº«ã€‚å¯ä»¥æŠŠå®ƒå½“ä½œå­¤ç«‹çš„ shapeï¼š</p><p><img src="../images/19-orphaned-shape.svg" alt="19-orphaned-shape" title="19-orphaned-shape"></p><p>ä½ å¯ä»¥æƒ³è±¡ï¼Œå¦‚æœæœ‰å¾ˆå¤šå¯¹è±¡çš„è¯ï¼Œè¿™æ ·ä¼šå˜å¾—å¾ˆç³Ÿç³•ï¼Œå› ä¸ºæ•´ä¸ª shape ç³»ç»Ÿå·²ç»å¤±å»ä»·å€¼ã€‚</p><p>åœ¨ React çš„æ¡ˆä¾‹ä¸­ï¼Œå½“å¼€å§‹åˆ†ææ•°æ®æ—¶ï¼ŒFiberNode ä¸Šçš„ä¸€äº›å­—æ®µéœ€è¦è®°å½•æ—¶é—´æˆ³ã€‚</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FiberNode</span> </span>&#123;</span><br><span class="line">  <span class="keyword">constructor</span>() &#123;</span><br><span class="line">    <span class="keyword">this</span>.actualStartTime = <span class="number">0</span>;</span><br><span class="line">    <span class="built_in">Object</span>.preventExtensions(<span class="keyword">this</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> node1 = <span class="keyword">new</span> FiberNode();</span><br><span class="line"><span class="keyword">const</span> node2 = <span class="keyword">new</span> FiberNode();</span><br></pre></td></tr></table></figure><p>è¿™äº›å­—æ®µï¼ˆæ¯”å¦‚ï¼ŒactualStartTimeï¼‰åˆå§‹åŒ–å€¼æ˜¯ 0 æˆ– -1ï¼Œå› æ­¤å±æ€§ç‰¹æ€§ Representation ä¸º Smiã€‚ä½†æ˜¯ï¼Œä¹‹åç”± <code>performance.now()</code> ç”Ÿæˆçš„æµ®ç‚¹å‹æ•°å€¼è¢«ä¿å­˜åœ¨è¿™äº›å­—æ®µä¸­ï¼Œå› æ­¤å±æ€§ç‰¹æ€§ Representation è¢«æ ‡è®°ä¸º Doubleã€‚é™¤æ­¤ä¹‹å¤–ï¼ŒReact è¿˜é˜»æ­¢ FiberNode å®ä¾‹æ‰©å±•å±æ€§ã€‚</p><p>åˆšå¼€å§‹çš„çŠ¶å†µå¦‚ä¸‹ï¼š</p><p><img src="../images/20-fibernode-shape.svg" alt="20-fibernode-shape" title="20-fibernode-shape"></p><p>å¦‚é¢„æœŸï¼Œä¸¤ä¸ªå®ä¾‹å…±äº«ç€ shape æ ‘ã€‚ä½†æ˜¯ä¹‹åï¼Œä¸€æ—¦ä½ å­˜å‚¨äº†çœŸå®çš„æ—¶é—´æˆ³ï¼ŒV8 å°±ä¼šæ— ä»ä¸‹æ‰‹ï¼š</p><p><img src="../images/21-orphan-islands.svg" alt="21-orphan-islands" title="21-orphan-islands"></p><p>V8 å…ˆåç»™ node1ï¼Œnode2 åˆ†åˆ«åˆ†é…äº†ç‹¬ç«‹çš„ shapeï¼Œä¸”å®ƒä»¬ä¹‹é—´æ²¡æœ‰ä»»ä½•å…³è”ã€‚çœŸå®ä¸­çš„ React åº”ç”¨æœ‰ç€æ•°ä¸‡ä¸ªè¿™æ ·çš„ FiberNodeã€‚ä½ å¯ä»¥æƒ³è±¡ï¼Œè¿™ç§æƒ…å†µå°†ä¼šä¸¥é‡å½±å“åˆ° V8 çš„æ€§èƒ½ã€‚</p><p>å¹¸è¿çš„æ˜¯ï¼Œè¿™ä¸ª<a href="https://chromium-review.googlesource.com/c/v8/v8/+/1442640/" rel="external nofollow noopener noreferrer" target="_blank">é—®é¢˜</a>åœ¨ <a href="https://v8.dev/blog/v8-release-74" rel="external nofollow noopener noreferrer" target="_blank">V8 v7.4</a> ä¸­è§£å†³äº†ã€‚ç ”å‘äººå‘˜æ‰¾åˆ°äº†æ”¹å˜å±æ€§ç‰¹æ€§ Representation çš„æ–¹æ³•ï¼ŒV8 ç»ˆäºçŸ¥é“å®ƒè¯¥æ€ä¹ˆåšäº†ï¼š</p><p><img src="../images/22-fix.svg" alt="22-fix" title="22-fix"></p><p>ä¸¤ä¸ª FiberNode å®ä¾‹æŒ‡å‘ä¸å¯æ‰©å±•çš„ shapeï¼Œshape ä¸­çš„ <code>actualStartTime</code> è¢«æ ‡è®°ä¸º Smiã€‚å½“ <code>node1.actualStartTime</code> è¢«åˆ†é…æ–°çš„å€¼æ—¶ï¼Œå°†ä¼šç”Ÿæˆä¸€æ¡æ–°çš„è¿‡æ¸¡é“¾ï¼Œè€Œä¸”ä¹‹å‰çš„è¿‡æ¸¡é“¾ä¼šè¢«æ ‡è®°ä¸ºåºŸå¼ƒçš„ã€‚</p><p><img src="../images/23-fix-fibernode-shape-1.svg" alt="23-fix-fibernode-shape-1" title="23-fix-fibernode-shape-1"></p><p>å¯ä»¥æ³¨æ„åˆ°ï¼Œç°åœ¨çš„è¿‡æ¸¡é“¾å¯ä»¥æ­£ç¡®çš„è¿‡æ¸¡è½¬ç§»ã€‚</p><p><img src="../images/24-fix-fibernode-shape-2.svg" alt="24-fix-fibernode-shape-2" title="24-fix-fibernode-shape-2"></p><p>å½“ <code>node2.actualStartTime</code> ä¹Ÿè¢«é‡æ–°åˆ†é…æ—¶ï¼Œæ‰€æœ‰çš„é“¾æ¥éƒ½æŒ‡å‘äº†æ–°çš„ shapeï¼Œè¿‡æ¸¡æ ‘ä¸­åºŸå¼ƒçš„éƒ¨åˆ†å°†ä¼šè¢«åƒåœ¾å›æ”¶æœºåˆ¶æ¸…é™¤ã€‚</p><p>React å›¢é˜Ÿå°† FiberNode æ‰€æœ‰å…³äºæ—¶é—´çš„å­—æ®µéƒ½æ”¹æˆäº† Double å½¢å¼ä»è€Œç¼“è§£è¿™ä¸ªé—®é¢˜ã€‚</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FiberNode</span> </span>&#123;</span><br><span class="line">  <span class="keyword">constructor</span>() &#123;</span><br><span class="line">    <span class="comment">// Force `Double` representation from the start.</span></span><br><span class="line">    <span class="keyword">this</span>.actualStartTime = <span class="built_in">Number</span>.NaN;</span><br><span class="line">    <span class="comment">// Later, you can still initialize to the value you want:</span></span><br><span class="line">    <span class="keyword">this</span>.actualStartTime = <span class="number">0</span>;</span><br><span class="line">    <span class="built_in">Object</span>.preventExtensions(<span class="keyword">this</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> node1 = <span class="keyword">new</span> FiberNode();</span><br><span class="line"><span class="keyword">const</span> node2 = <span class="keyword">new</span> FiberNode();</span><br></pre></td></tr></table></figure><p>ç”± React å…·ä½“çš„ Bug å¼•å‡ºäº† V8 ç‰¹æœ‰çš„é—®é¢˜ï¼Œé€šå¸¸æ¥è¯´ï¼Œå¼€å‘è€…ä¸å¿…å¯¹æŸä¸ªç‰ˆæœ¬çš„ JavaScript å¼•æ“åšä¼˜åŒ–ã€‚ä¸è¿‡ï¼Œå½“æ—¶äº‹æƒ…å‘ä¸å¥½çš„æ–¹å‘å‘å±•æ—¶ï¼Œæˆ‘ä»¬ä¹Ÿä¸ä¼šæŸæ‰‹æ— ç­–ã€‚</p><p>è¦çŸ¥é“ JavaScript å¼•æ“åœ¨å¹•ååšäº†å¾ˆå¤šäº‹ï¼Œå°½å¯èƒ½çš„ä¸è¦å»æ··åˆç±»å‹ã€‚ä¾‹å¦‚ï¼Œç»™ä¸€ä¸ªæ•°å­—å­—æ®µåˆå§‹åŒ–ä¸º nullï¼Œè¿™æ ·åšçš„è¯ä¼šä½¿å¾—ä¸€äº›ä¼˜åŒ–åŒ–ä¸ºæ³¡å½±ï¼Œè€Œä¸”å¯è¯»æ€§é™ä½ã€‚</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Donâ€™t do this!</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Point</span> </span>&#123;</span><br><span class="line">  x = <span class="literal">null</span>;</span><br><span class="line">  y = <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> p = <span class="keyword">new</span> Point();</span><br><span class="line">p.x = <span class="number">0.1</span>;</span><br><span class="line">p.y = <span class="number">402</span>;</span><br></pre></td></tr></table></figure><p>æ¢å¥è¯è¯´ï¼Œå†™å¯è¯»æ€§ä»£ç ï¼Œæ€§èƒ½è‡ªç„¶ä¼šç´§è·Ÿå…¶åï¼</p><h2 id="Take-aways"><a href="#Take-aways" class="headerlink" title="Take-aways"></a>Take-aways</h2><p>æœ¬æ–‡è¦†ç›–äº†ä¸€ä¸‹å‡ ç‚¹ï¼š</p><ol><li>JavaScript åŒºåˆ†äº† primitives å’Œ objectsï¼Œè€Œä¸” typeof ä¸é è°±ã€‚</li><li>å³ä½¿æ˜¯ç›¸åŒç±»å‹çš„å€¼ä¹Ÿä¼šæœ‰ä¸åŒçš„è¡¨è¾¾å½¢å¼ã€‚</li><li>JavaScript å¼•æ“ä¼šä¸ºæ¯ä¸ªå±æ€§æ‰¾åˆ°æœ€ä¼˜çš„è¡¨è¾¾å½¢å¼ã€‚</li><li>è®¨è®ºäº† V8 å¤„ç† shape çš„åºŸå¼ƒï¼Œè¿ç§»å’Œå¯æ‰©å±•ã€‚</li></ol><p>åŸºäºä»¥ä¸Šçš„çŸ¥è¯†ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ä¸€äº› JavaScript ç¼–ç¨‹æŠ€å·§æ¥æå‡æ€§èƒ½ï¼š</p><ol><li>ä»¥ç›¸åŒçš„æ–¹å¼åˆå§‹åŒ–å¯¹è±¡ç±»å‹ï¼Œè¿™æ · shape ç³»ç»Ÿä¼šæ›´é«˜æ•ˆã€‚</li><li>ä¸ºä½ çš„å­—æ®µé€‰æ‹©åˆç†çš„å€¼ï¼ˆã€ŒRepresentationã€ï¼šSmi æˆ– é Smiï¼‰ã€‚</li></ol></div><div><div><div style="text-align:center;color:#555;font-size:18px">------------- The End -------------</div></div></div><div><ul class="post-copyright"><li class="post-copyright-author"><strong>æœ¬æ–‡ä½œè€…ï¼š</strong> è´ªç©º</li><li class="post-copyright-link"><strong>æœ¬æ–‡é“¾æ¥ï¼š</strong> <a href="https://yexiaochen.github.io/ã€è¯‘ã€‘The-story-of-a-V8-performance-cliff-in-React/" title="ã€è¯‘ã€‘The story of a V8 performance cliff in React">https://yexiaochen.github.io/ã€è¯‘ã€‘The-story-of-a-V8-performance-cliff-in-React/</a></li><li class="post-copyright-license"><strong>ç‰ˆæƒå£°æ˜ï¼š </strong>æœ¬åšå®¢æ‰€æœ‰æ–‡ç« é™¤ç‰¹åˆ«å£°æ˜å¤–ï¼Œå‡é‡‡ç”¨ <a href="https://creativecommons.org/licenses/by-nc-sa/3.0/" rel="external nofollow noopener noreferrer" target="_blank">CC BY-NC-SA 3.0</a> è®¸å¯åè®®ã€‚è½¬è½½è¯·æ³¨æ˜å‡ºå¤„ï¼</li></ul></div><footer class="post-footer"><div class="post-tags"><a href="/tags/JavaScript-å¼•æ“/" rel="tag"><i class="fa fa-tag"></i> JavaScript å¼•æ“</a> <a href="/tags/V8/" rel="tag"><i class="fa fa-tag"></i> V8</a></div><div class="post-nav"><div class="post-nav-next post-nav-item"><a href="/ã€è¯‘ã€‘JavaScript-engine-fundamentals-optimizing-prototypes/" rel="next" title="ã€è¯‘ã€‘JavaScript engine fundamentals: optimizing prototypes"><i class="fa fa-chevron-left"></i> ã€è¯‘ã€‘JavaScript engine fundamentals: optimizing prototypes</a></div><span class="post-nav-divider"></span><div class="post-nav-prev post-nav-item"><a href="/è¯»ã€Šä¹Œåˆä¹‹ä¼—ã€‹/" rel="prev" title="è¯»ã€Šä¹Œåˆä¹‹ä¼—ã€‹">è¯»ã€Šä¹Œåˆä¹‹ä¼—ã€‹ <i class="fa fa-chevron-right"></i></a></div></div></footer></div></article><div class="post-spread"></div></div></div><div class="comments" id="comments"><div onclick="showGitment()" id="gitment-display-button">æ˜¾ç¤ºè¯„è®º</div><div id="gitment-container" style="display:none"></div></div></div><div class="sidebar-toggle"><div class="sidebar-toggle-line-wrap"><span class="sidebar-toggle-line sidebar-toggle-line-first"></span> <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span> <span class="sidebar-toggle-line sidebar-toggle-line-last"></span></div></div><aside id="sidebar" class="sidebar"><div id="sidebar-dimmer"></div><div class="sidebar-inner"><ul class="sidebar-nav motion-element"><li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">æ–‡ç« ç›®å½•</li><li class="sidebar-nav-overview" data-target="site-overview-wrap">ç«™ç‚¹æ¦‚è§ˆ</li></ul><section class="site-overview-wrap sidebar-panel"><div class="site-overview"><div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person"><img class="site-author-image" itemprop="image" src="/images/avatar.jpeg" alt="è´ªç©º"><p class="site-author-name" itemprop="name">è´ªç©º</p><p class="site-description motion-element" itemprop="description"></p></div><nav class="site-state motion-element"><div class="site-state-item site-state-posts"><a href="/archives/"><span class="site-state-item-count">68</span> <span class="site-state-item-name">æ—¥å¿—</span></a></div><div class="site-state-item site-state-categories"><a href="/categories/index.html"><span class="site-state-item-count">11</span> <span class="site-state-item-name">åˆ†ç±»</span></a></div><div class="site-state-item site-state-tags"><a href="/tags/index.html"><span class="site-state-item-count">118</span> <span class="site-state-item-name">æ ‡ç­¾</span></a></div></nav><div class="feed-link motion-element"><a href="/atom.xml" rel="alternate"><i class="fa fa-rss"></i> RSS</a></div><div class="links-of-author motion-element"><span class="links-of-author-item"><a href="mailto:2277438436@qq.com" target="_blank" title="E-Mail" rel="external nofollow noopener noreferrer"><i class="fa fa-fw fa-envelope"></i>E-Mail</a></span></div></div></section><section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active"><div class="post-toc"><div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#å‰è¨€"><span class="nav-number">1.</span> <span class="nav-text">å‰è¨€</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#JavaScript-types"><span class="nav-number">2.</span> <span class="nav-text">JavaScript types</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Value-representation"><span class="nav-number">3.</span> <span class="nav-text">Value representation</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Smi-vs-HeapNumber-vs-MutableHeapNumber"><span class="nav-number">4.</span> <span class="nav-text">Smi vs. HeapNumber vs. MutableHeapNumber</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Shape-deprecations-and-migrations"><span class="nav-number">5.</span> <span class="nav-text">Shape deprecations and migrations</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Extensibility-and-integrity-level-transitions"><span class="nav-number">6.</span> <span class="nav-text">Extensibility and integrity-level transitions</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#The-React-performance-issue"><span class="nav-number">7.</span> <span class="nav-text">The React performance issue</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Take-aways"><span class="nav-number">8.</span> <span class="nav-text">Take-aways</span></a></li></ol></div></div></section></div></aside></div></main><footer id="footer" class="footer"><div class="footer-inner"><div class="copyright">&copy; 2018 &mdash; <span itemprop="copyrightYear">2023</span> <span class="with-love"><i class="fa fa-user"></i> </span><span class="author" itemprop="copyrightHolder">è´ªç©º</span></div></div></footer><div class="back-to-top"><i class="fa fa-arrow-up"></i></div></div><script type="text/javascript">"[object Function]"!==Object.prototype.toString.call(window.Promise)&&(window.Promise=null)</script><script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script><script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/fastclick/1.0.6/fastclick.min.js"></script><script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jquery_lazyload/1.9.7/jquery.lazyload.min.js"></script><script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/velocity/1.2.1/velocity.min.js"></script><script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/velocity/1.2.1/velocity.ui.min.js"></script><script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script><script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script><script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script><script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script><script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.css"><script src="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js"></script><style>a.gitment-editor-footer-tip{display:none}.gitment-container.gitment-footer-container{display:none}</style><script type="text/javascript">function renderGitment(){new Gitalk({id:window.decodeURIComponent(window.location.pathname),owner:"yexiaochen",repo:"blogComments",distractionFreeMode:!1,admin:["yexiaochen"],clientSecret:"5df7f4f6edb8a65fef2d0cf7cb6fa40b04a44525",clientID:"fad749b2b67be41f767a"}).render("gitment-container")}function showGitment(){document.getElementById("gitment-display-button").style.display="none",document.getElementById("gitment-container").style.display="block",renderGitment()}</script><script>!function(){var t=document.createElement("script"),e=window.location.protocol.split(":")[0];t.src="https"===e?"https://zz.bdstatic.com/linksubmit/push.js":"http://push.zhanzhang.baidu.com/push.js";var s=document.getElementsByTagName("script")[0];s.parentNode.insertBefore(t,s)}()</script></body></html>